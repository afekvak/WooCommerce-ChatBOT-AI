PROJECT STRUCTURE DOCUMENTATION
WooCommerce MCP Server / WooCommerce ChatBOT AI

This document explains the purpose of the main folders and files in the project.
Use it as a reference when working on tools, LLM logic, the widget, and the WordPress plugin.

==================================================
ROOT LEVEL
==================================================

README.md
  High level overview of the project, how to run the server, and what the assistant does.

package.json
  Node package manifest.
  Defines scripts such as build and dev and lists all dependencies and devDependencies.

tsconfig.json
  TypeScript configuration for compiling the project.

.env (not committed, created locally)
  Environment configuration file.
  Typical keys:
    OPENAI_API_KEY
    PORT
    JWT_SECRET (for future encrypted keys)
    WOO_URL (default WooCommerce store url)
    WOO_CK  (default WooCommerce consumer key)
    WOO_CS  (default WooCommerce consumer secret)

docs/
  Documentation and notes for the project.
  Can include architecture diagrams, API notes, and design decisions.

postman/
  Collection and environment files for testing HTTP endpoints with Postman.
  Useful for testing /chat, health checks, and any future admin API.

plugin-build/
  Contains the built WordPress plugin that injects the widget into the WordPress admin.

  plugin-build/woo-mcp-assistant.php
    Main plugin file for WordPress.
    Adds an admin menu page called Woo MCP Assistant.
    Stores a client key in the wp_options table.
    Injects a script tag with the widget runtime into the admin footer when a client key is configured.
    The script tag points to the MCP server and passes:
      data-server      url of the /chat endpoint
      data-client-key  client key that identifies the tenant in the MCP database

public/
  Static assets that are served directly by Express.

  public/widget.html
    Standalone test page for the frontend chat widget.
    Useful for testing the widget without using WordPress.

  public/widget.js
    Legacy widget bundle.
    Earlier version of the floating chat widget script.

  public/widget.runtime.js
    Current widget runtime used by WordPress and by widget.html.
    Responsible for:
      Rendering the chat user interface
      Reading widget config from window.__MCP_WIDGET_CONFIG__ and fallbacks
      Sending user messages to POST /chat with clientKey
      Rendering HTML responses from the server
      Displaying the debug block when present
      Saving chat history in local storage
      Showing a typing indicator
      Supporting wide mode layout
      Handling wizard confirmation meta blocks and opening confirmation modals
      Optional future: loading ui settings from GET /client-config

==================================================
SRC ROOT
==================================================

src/app.ts
  Creates and configures the Express application.
  Sets up JSON body parsing, CORS handling, and attaches the main router.
  Does not start listening on a port.
  Note: CORS logic has been moved to src/middleware/cors.ts.

src/server.ts
  Main backend entry point.
  Creates the MCP server instance.
  Registers all tools and wizards.
  Attaches the MCP server to Express.
  Starts the HTTP server and listens on the configured PORT.

src/types.ts (or src/mcp/types.ts depending on location)
  Shared TypeScript types used across the MCP and routing layers.
  Examples:
    BotReply      shape of the object returned from handleUserMessage
    MCPToolResponse
    ClientContext
    ToolCtx

==================================================
DATABASE LAYER
==================================================

db/
  Database connection utilities and tests.

  db/pool.ts
    Creates and exports a PostgreSQL connection pool.
    Central place where the database connection string is configured.
    Used by other modules that need to talk to the database, for example client storage.

  db/testdb.ts
    Simple script to test the PostgreSQL connection.
    Connects to the pool, performs a simple query, and logs the result.
    Used to verify that database credentials are correct.

==================================================
MIDDLEWARE LAYER
==================================================

src/middleware/
  Reusable Express middleware modules.

  src/middleware/resolveClient.ts
    Reads the client key coming from each request.
    The client key is provided by the widget through header or body.
    Looks up the client in the database using the key.
    Attaches a ClientContext object to the request, containing:
      client id
      client name
      client key
      WooCommerce url and keys for that client
    This context is then passed into the MCP LLM router so tools know which tenant to use.

  src/middleware/resolveClientConfig.ts
    Loads per client configuration from mcp_client_config table.
    Attaches a ClientConfig object to the request, containing:
      prefs        server side behavior preferences such as allowRealName
      settings     server side operational settings (placeholders for future confirmations and other toggles)
      ui           ui preferences such as theme, scale, defaultWide
    Ensures defaults are applied when the row or fields are missing.
    Used by /chat so the LLM layer can behave consistently per client.

  src/middleware/jwtAuth.ts
    Authentication helper based on JSON Web Tokens.
    Designed to decrypt or unwrap WooCommerce credentials stored in the database.
    In the current phase it prepares the structure for future encrypted storage.

  src/middleware/cors.ts
    Central CORS configuration.
    Exports a middleware instance or function that sets:
      allowed origins
      allowed headers
      allowed methods
    Used by src/app.ts so CORS rules are defined in one place.

==================================================
CLIENT CONFIG
==================================================

src/clientConfig/
  Centralized definitions for per client preferences and UI behavior.
  This folder is the main place to expand settings in the future.

  src/clientConfig/types.ts
    TypeScript types for the client configuration object.
    Examples:
      ClientConfig
      ClientPrefs
      ClientSettings
      UiSettings

  src/clientConfig/defaults.ts
    Default configuration values used when:
      a client has no row in mcp_client_config
      a json field is missing or invalid

  src/clientConfig/service.ts
    Optional helper service to load and cache config from the database.
    Can be used if you prefer a service layer instead of middleware only.
    If you use the middleware resolver directly, this file can still remain as a reusable utility for future routes.

==================================================
CONTROLLERS
==================================================

src/controllers/
  Low level WooCommerce REST operations and helper clients.
  These functions do not know about the LLM or chat, only about calling the WooCommerce API.

  src/controllers/wooClient.ts
    Factory that creates a WooCommerce REST API client for a given url and keys.
    Wraps axios or a dedicated WooCommerce client.
    Used by controllers that need to perform GET, POST, PUT, or DELETE on WooCommerce endpoints.

  src/controllers/wooAddController.ts
    Operations for creating new products in WooCommerce.
    Exposes createProduct, which takes url, ck, cs, and a product payload.
    Returns the raw WooCommerce product object.

  src/controllers/wooGetController.ts
    Operations for reading products and related data.
    Functions include:
      getProducts
      getProductById
      getProductBySku
      getProductByName
      getProductsByCategory
    All functions call WooCommerce and return the fetched JSON.

  src/controllers/wooUpdateController.ts
    Operations for updating existing products.
    Functions include:
      updateProduct        update by numeric id
      updateProductBySku   resolve product by sku and then update by id

  src/controllers/wooDeleteController.ts
    Operations for deleting products from WooCommerce.
    Can support soft delete or force delete depending on flags.

==================================================
MCP CORE
==================================================

src/mcp/
  Contains the MCP server integration, tool registration layer, resources, and LLM logic.

  src/mcp/prompts.ts
    System prompts and instruction templates used by the LLM.
    Defines how the assistant should speak and which tools it is allowed to use.

  src/mcp/resources.ts
    Optional MCP resources definition for external MCP clients.
    Describes non tool resources if needed.

  src/mcp/types.ts
    Shared types that are specific to the MCP and tool layer.
    Helps keep handlers strongly typed.
    Includes ToolCtx which now supports clientConfig, enabling tools and wizards to read settings.

  src/mcp/registry.ts
    Simple registry object that mirrors every registered tool.
    Shape:
      registeredTools[toolName] = { meta, handler }
    Used by the LLM router to manually call tools by name during fast rules or wizards.

==================================================
MCP TOOLS  WOO LAYER
==================================================

src/mcp/woo/
  WooCommerce specific logic on top of controllers.

  src/mcp/woo/wooCredentials.ts
    Central resolver for WooCommerce credentials.
    Accepts:
      tool arguments  which may contain url, ck, cs
      ToolCtx         which includes client context
      environment variables as fallback
    Resolution order for each field is:
      args value
      ctx.client value from the database
      process.env default value
    Throws a clear error if any required credential is missing.
    This ensures that tools behave correctly for each tenant.

  src/mcp/woo/registry.ts
    Local registry specific to Woo tools.
    Allows looking up handlers such as woo_get_products at runtime.

  src/mcp/woo/wooTools/
    Grouped files that register concrete tools on the MCP server.

    wooAddTools.ts
      Registers the woo_create_product tool.
      Uses WooCreateProductArgs and wooCreateProductSchema.
      Calls createProduct controller with credentials from resolveWooCredentials.
      Formats the created product with formatSingleProduct and returns HTML.

    wooGetTools.ts
      Registers all read only tools:
        woo_get_products
        woo_get_product_by_id
        woo_get_product_by_sku
        woo_get_products_by_name
        woo_get_products_by_category
      Each handler uses resolveWooCredentials and delegates to the correct controller function.
      Results are rendered with formatProducts or formatSingleProduct.

    wooUpdateTools.ts
      Registers tools for updating products:
        woo_update_product_by_id
        woo_update_product_by_sku
      Each handler uses resolveWooCredentials and delegates to updateProduct or updateProductBySku.
      Returns formatted HTML for the updated product.

    wooDeleteTools.ts
      Registers tools for deleting products:
        for example woo_delete_product_by_id or by sku.
      Uses delete controllers and returns confirmation messages.

  src/mcp/woo/wooSchemas/
    Zod schemas for WooCommerce tools.
    Each file defines the shape of the tool input.

    addSchemas.ts
      Base fields for credentials plus product data object.

    getSchemas.ts
      Input definitions for all read tools such as id, sku, name, category, and pagination.

    updateSchemas.ts
      Input definitions for update tools and allowed payload fields.

    deleteSchemas.ts
      Input definitions for delete tools.

  src/mcp/woo/args/
    Type definitions derived from Zod schemas.
    Keeps TypeScript handlers clean and strongly typed.

    addArgs.ts
      Defines WooCreateProductArgs.

    getArgs.ts
      Defines:
        WooGetProductsArgs
        WooGetProductByIdArgs
        WooGetProductBySkuArgs
        WooGetProductsByNameArgs
        WooGetProductsByCategoryArgs

    updateArgs.ts
      Defines WooUpdateProductByIdArgs and WooUpdateProductBySkuArgs.

    deleteArgs.ts
      Defines delete argument types.

==================================================
MCP LLM LAYER
==================================================

src/mcp/llm/
  Core hybrid LLM logic for the main chat endpoint.

  src/mcp/llm/history.ts
    Very small in memory history for the current conversation.
    Provides addUserMessage and addAssistantMessage.
    Used mainly to give the LLM short context.

  src/mcp/llm/intentAnalyzer.ts
    Uses the LLM to decide whether to call a tool or stay in normal chat.
    Returns an IntentDecision with:
      shouldUseTool  boolean
      toolName       selected tool
      args           tool arguments
      reason         explanation text

  src/mcp/llm/llm.ts
    Wrapper around the OpenAI chat completion API.
    Uses environment configuration for model, temperature, and keys.
    Fallback llm and Free text LLM calls like small helpers.

  src/mcp/llm/quickRules.ts
    Fast pattern rules that run before the LLM.
    Handles simple numeric queries, guardrails, and wizard start phrases.

  src/mcp/llm/router.ts
    Main entry point for the chat logic that backs POST /chat.
    Steps:
      1  add the user message to history
      2  determine session id per client
      3  load clientConfig behavior flags and derive display logic such as allowRealName
      4  if a wizard is active continue the wizard flow
      5  if fast rules match execute the selected tool
      6  otherwise call analyzeIntent and possibly run a tool
      7  if no tool is used, fall back to plain LLM chat
    Returns BotReply objects of the form:
      { text, debug }
    The debug field includes:
      mode            how the message was handled
      selected tool   when relevant
      intent reason   from the LLM
      client info     client id, clientKey, name, store url masked keys
      client config   when enabled in debug, shows the active prefs and ui snapshot

  src/mcp/llm/setupLLMTool.ts
    Registers a simple llm tool into the MCP server.
    The tool takes a message field and returns a plain LLM reply.
    It also mirrors tool handlers into registeredTools for debug usage.

==================================================
PRODUCT WIZARDS
==================================================

src/mcp/llm/wizards/
  Multi step flows for complex tasks.

  createProductWizard/
    handler.ts
      Implements the guided product creation wizard.
      Supports two modes:
        guided questions
        raw JSON payload
      Asks for basic fields, optional advanced sections, then confirmation.
      Calls createProduct and returns formatted HTML.
      Can include a debug block with the exact JSON payload sent to WooCommerce.

    state.ts
      Defines the WizardState interface and helpers:
        getWizard
        setWizard
        clearWizard
      Stores the current stage, collected data, and indices for questions.

  updateProductWizard/
    state.ts
      Holds UpdateProductWizardState including:
        productId
        originalProduct
        selected field list
        payload to update

    handler.ts
      Implements the update wizard.
      Locates product by id or sku using getProductById or getProductBySku.
      Lets the user choose fields to update, asks new values, then builds a summary.
      Creates a confirmation block with [[WIZARD_CONFIRM_META]] and waits for confirm or cancel.
      On confirm calls updateProduct and returns updated product HTML.

  bulkUpdateWizard/
    state.ts and handler.ts
      Similar structure for bulk updates such as updating many products by category or filter.
      This wizard builds high level instructions and then applies them through a tool.

==================================================
ROUTING
==================================================

src/routes/appRouter.ts
  Defines HTTP routes for the Express app.

  POST /chat
    Main endpoint used by the widget and by WordPress.
    Uses middleware to resolve:
      ClientContext from src/middleware/resolveClient.ts
      ClientConfig  from src/middleware/resolveClientConfig.ts
    Calls handleUserMessage(message, mcpServer, { client, clientConfig }) and returns:
      text   rendered HTML or answer
      debug  JSON string for the debug panel inside the widget when enabled

  GET /client-config
    Optional helper endpoint used by the widget to fetch ui settings for the current client key.
    Returns the same ClientConfig object that is attached during /chat.

  GET /health
    Health check endpoint for uptime checks.

  POST /mcp
    Endpoint for external MCP clients if enabled.

==================================================
UTILITIES
==================================================

src/utils/formatWoo.ts
  Utility helpers that convert WooCommerce product JSON into HTML fragments.
  Functions include:
    formatProducts       grid of product cards
    formatSingleProduct  detailed product card
    formatProductBySku   view specialized for sku lookup
  These helpers centralize all markup for Woo products so the LLM and tools stay domain focused.

==================================================
HOW THE CLIENT AND USER SYSTEM FITS TOGETHER
==================================================

  The WordPress site installs the woo mcp assistant plugin.
  In the plugin settings screen the site owner pastes the client key issued by the MCP backend.
  The plugin injects widget.runtime.js into the admin pages with:
    data-server      url of the MCP /chat endpoint
    data-client-key  the stored client key
  When the user types a message in the widget, it calls POST /chat with that client key.
  Express runs resolveClient middleware, which:
    looks up the client record in the database using the client key
    attaches ClientContext with WooCommerce url and keys
  Express runs resolveClientConfig middleware, which:
    loads per client prefs and ui settings from mcp_client_config
    applies defaults when missing
  The chat route calls handleUserMessage and passes both:
    client context
    client config
  Tools that need WooCommerce credentials call resolveWooCredentials.
  resolveWooCredentials reads:
    explicit args from the tool
    ctx.client values from the database
    .env defaults as a last fallback
  This way the same MCP server can serve many different WooCommerce stores, each with its own keys, through a single chat widget implementation.
